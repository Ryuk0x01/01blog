<!-- Main Content -->
<main class="main-content">

  <!-- Error message -->
  @if (errorMessage()) {
  <div class="error-alert">
    <mat-icon>error_outline</mat-icon>
    {{ errorMessage() }}
  </div>
  }

  @if (loadingPosts()) {
  <div class="loading-container">
    <mat-spinner diameter="36"></mat-spinner>
    <p>Loading posts...</p>
  </div>
  }

  @if (showCreatePost) {
  <div class="create-post-wrapper">
    <app-create-post></app-create-post>
  </div>
  }



  @if (!posts().length && !loadingPosts()) {
  <div class="no-posts">
    <mat-icon class="no-posts-icon">article</mat-icon>
    <p>No posts available yet</p>
    <span>Be the first to share something!</span>
  </div>
  }


  @for (p of posts(); track p.id) {
  <mat-card class="post-card" appearance="outlined">
    <mat-card-header class="post-header">
      <div class="avatar-placeholder" mat-card-avatar>
        {{ p.authorUsername.charAt(0).toUpperCase() }}
      </div>
      <mat-card-title class="post-author">{{ p.authorUsername }}</mat-card-title>
      <mat-card-subtitle class="post-date">{{ p.createdAt | date:'mediumDate' }}</mat-card-subtitle>
    </mat-card-header>

    @if (p.title) {
    <div class="post-title-bar">
      <h2 class="post-title">{{ p.title }}</h2>
    </div>
    }

    <mat-card-content class="post-body">
      @if (p.mediaUrl) {
      <div class="post-media-wrapper">
        @if (p.mediaUrl.includes('.mp4') || p.mediaUrl.includes('.webm') || p.mediaUrl.includes('.ogg')) {
        <video controls class="post-media">
          <source src="http://localhost:8080{{ p.mediaUrl }}">
          Your browser does not support the video tag.
        </video>
        } @else {
        <img class="post-media" src="http://localhost:8080{{ p.mediaUrl }}" alt="Post image">
        }
      </div>
      }

      <p class="post-content">{{ p.content }}</p>
    </mat-card-content>

    @if (editingPostId() === p.id) {
    <div class="edit-form">
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Edit title</mat-label>
        <input matInput type="text" placeholder="Post title..." [(ngModel)]="editTitle" name="editTitle"
          [disabled]="editing()">
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Edit content</mat-label>
        <textarea matInput rows="3" placeholder="What's on your mind?" [(ngModel)]="editContent" name="editContent"
          [disabled]="editing()"></textarea>
      </mat-form-field>

      <div class="file-input-wrapper">
        <input type="file" #editFile class="file-input" id="editFile" (change)="onEditFileSelected($event)"
          accept="image/*,video/*" [disabled]="editing()">
        <button mat-raised-button type="button" color="primary" (click)="editFile.click()" [disabled]="editing()">
          <mat-icon>attach_file</mat-icon>
          Choose Image/Video
        </button>
      </div>

      @if (editSelectedFile()) {
      <div class="selected-file-alert">
        <span>üìÅ {{ editSelectedFile()!.name }} ({{ (editSelectedFile()!.size / 1024 / 1024).toFixed(2) }}MB)</span>
        <button mat-icon-button (click)="editSelectedFile.set(null)">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      }

      <div class="edit-actions">
        <button mat-raised-button color="primary" type="button" (click)="saveEdit(p.id)" [disabled]="editing()">
          <mat-icon>{{ editing() ? 'hourglass_empty' : 'save' }}</mat-icon>
          {{ editing() ? 'Saving...' : 'Save' }}
        </button>
        <button mat-button type="button" (click)="cancelEdit()" [disabled]="editing()">Cancel</button>
      </div>
    </div>
    }

    <mat-card-actions class="post-actions">
      <button mat-button class="action-btn" [class.liked]="postLikes()[p.id]" (click)="likePost(p.id)">
        <mat-icon color="{{ postLikes()[p.id] ? 'primary' : '' }}">
          {{ postLikes()[p.id] ? 'thumb_up' : 'thumb_up_off_alt' }}
        </mat-icon>
        <span>Like ({{ postLikesCount()[p.id] }})</span>
      </button>

      <button mat-button class="toggle-btn" (click)="commentComponent.toggleComments()">
        <mat-icon>{{ commentComponent.showComments() ? 'expand_less' : 'chat_bubble_outline' }}</mat-icon>
        <span>{{ commentComponent.showComments() ? 'Hide Comments' : 'Comments' }} ({{ postCommentCounts()[p.id]
          }})</span>
      </button>

      @if (auth.getUsername() === p.authorUsername) {
      <button mat-button class="action-btn" (click)="startEdit(p)">
        <mat-icon>edit</mat-icon>
        <span>Edit</span>
      </button>

      <button mat-button class="delete-btn" (click)="deletePost(p.id)">
        <mat-icon>delete</mat-icon>
        <span>Delete</span>
      </button>
      }
    </mat-card-actions>

    <app-comment #commentComponent [postId]="p.id"></app-comment>

  </mat-card>
  }


</main>