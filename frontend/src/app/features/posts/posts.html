<!-- Main Content -->
<main class="main-content fade-in-up">
  @if (errorMessage()) {
  <div class="error-alert">
    <mat-icon>error_outline</mat-icon>
    {{ errorMessage() }}
  </div>
  }

  @if (loadingPosts()) {
  <div class="loading-container">
    <mat-spinner diameter="36"></mat-spinner>
    <p>Loading posts...</p>
  </div>
  }

  @if (showCreateButton) {
  <div class="sidebar-actions">
    <button mat-flat-button color="primary" class="create-btn" (click)="showCreatePost.set(!showCreatePost())">
      <mat-icon>add</mat-icon>
      Create Post
    </button>
  </div>

  @if (showCreatePost()) {
  <div class="create-post-wrapper">
    <app-create-post></app-create-post>
  </div>
  }
  }



  @if (!posts().length && !loadingPosts()) {
  <div class="no-posts">
    <mat-icon class="no-posts-icon">article</mat-icon>
    <p>No posts available yet</p>
    <span>Be the first to share something!</span>
  </div>
  }


  @for (p of posts(); track p.id) {
  <mat-card class="post-card" appearance="outlined">
    <mat-card-header class="post-header">
      <div class="avatar-placeholder" mat-card-avatar>
        {{ p.authorUsername.charAt(0).toUpperCase() }}
      </div>
      <mat-card-title class="post-author">{{ p.authorUsername }}</mat-card-title>
      <mat-card-subtitle class="post-date">{{ p.createdAt | date:'mediumDate' }}</mat-card-subtitle>
    </mat-card-header>

    @if (p.title) {
    <div class="post-title-bar">
      <h2 class="post-title">{{ p.title }}</h2>
    </div>
    }

    <mat-card-content class="post-body">
      @if (p.mediaUrl) {
      <div class="post-media-wrapper">
        @if (p.mediaUrl.includes('.mp4') || p.mediaUrl.includes('.webm') || p.mediaUrl.includes('.ogg')) {
        <video controls class="post-media">
          <source src="http://localhost:8080{{ p.mediaUrl }}">
          Your browser does not support the video tag.
        </video>
        } @else {
        <img class="post-media" src="http://localhost:8080{{ p.mediaUrl }}" alt="Post image">
        }
      </div>
      }

      <p class="post-content">{{ p.content }}</p>
    </mat-card-content>

    @if (editingPostId() === p.id) {
    <div class="edit-zone fade-in">
      <div class="edit-header">
        <h3>Edit Post</h3>
        <p>Update your post's content and media</p>
      </div>

      <div class="edit-fields">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Title</mat-label>
          <input matInput type="text" placeholder="Something catchy..." [ngModel]="editTitle()"
            (ngModelChange)="editTitle.set($event)" name="editTitle" [disabled]="editing()">
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Content</mat-label>
          <textarea matInput rows="4" placeholder="Share your story..." [ngModel]="editContent()"
            (ngModelChange)="editContent.set($event)" name="editContent" [disabled]="editing()"></textarea>
        </mat-form-field>
      </div>

      <div class="edit-media-section">
        <input type="file" #editFile class="file-input-hidden" id="editFile" (change)="onEditFileSelected($event)"
          accept="image/*,video/*" [disabled]="editing()">

        <div class="media-actions">
          <button mat-stroked-button type="button" (click)="editFile.click()" [disabled]="editing()" class="media-btn">
            <mat-icon>add_photo_alternate</mat-icon>
            {{ editSelectedFile() ? 'Change Media' : 'Update Media' }}
          </button>

          @if (editSelectedFile()) {
          <div class="file-badge">
            <mat-icon>insert_drive_file</mat-icon>
            <span>{{ editSelectedFile()!.name }}</span>
            <button mat-icon-button (click)="editSelectedFile.set(null)" class="clear-file">
              <mat-icon>close</mat-icon>
            </button>
          </div>
          }
        </div>
      </div>

      <div class="edit-footer">
        <button mat-button type="button" (click)="cancelEdit()" [disabled]="editing()"
          class="cancel-btn">Cancel</button>
        <button mat-flat-button color="primary" type="button" (click)="saveEdit(p.id)" [disabled]="editing()"
          class="save-btn">
          <mat-icon>{{ editing() ? 'hourglass_empty' : 'check' }}</mat-icon>
          {{ editing() ? 'Saving...' : 'Save Changes' }}
        </button>
      </div>
    </div>
    }

    <mat-card-actions class="post-actions">
      <button mat-button class="action-btn" [class.liked]="postLikes()[p.id]" (click)="likePost(p.id)">
        <mat-icon color="{{ postLikes()[p.id] ? 'primary' : '' }}">
          {{ postLikes()[p.id] ? 'thumb_up' : 'thumb_up_off_alt' }}
        </mat-icon>
        <span>Like ({{ postLikesCount()[p.id] }})</span>
      </button>

      <button mat-button class="toggle-btn" (click)="commentComponent.toggleComments()">
        <mat-icon>{{ commentComponent.showComments() ? 'expand_less' : 'chat_bubble_outline' }}</mat-icon>
        <span>{{ commentComponent.showComments() ? 'Hide Comments' : 'Comments' }} ({{ postCommentCounts()[p.id]
          }})</span>
      </button>

      @if (auth.getUsername() === p.authorUsername) {
      <button mat-button class="action-btn" (click)="startEdit(p)">
        <mat-icon>edit</mat-icon>
        <span>Edit</span>
      </button>

      <button mat-button class="delete-btn" (click)="deletePost(p.id)">
        <mat-icon>delete</mat-icon>
        <span>Delete</span>
      </button>
      } @else {
      <button mat-button class="action-btn" (click)="reportPost(p.id)">
        <mat-icon>flag</mat-icon>
        <span>Report</span>
      </button>
      }
    </mat-card-actions>

    <app-comment #commentComponent [postId]="p.id"></app-comment>

  </mat-card>
  }


</main>